version: "3.8"
services:
  db:
    image: vifa951002/msc_dev_database
    environment:
      MYSQL_ROOT_PASSWORD: admin

    ports:
      - "3306"
  loki:
    image: grafana/loki:2.9.0
    restart: always

    command: -config.file=/etc/loki/local-config.yaml
    depends_on:
      - grafana
  minio:
    image: minio/minio
    ports:
      - "9000"
      - "9001"
    restart: always
    environment:
      MINIO_ROOT_USER: VIFA-951002
      MINIO_ROOT_PASSWORD: VIFA-951002-PASS
      MINIO_ADDRESS: ":9000"
      MINIO_CONSOLE_ADDRESS: ":9001"
    volumes:
      - minio_data:/data
    command: server /data
  rabbitmq:
    image: rabbitmq:4-management
    ports:
      - "5672"
      - "15672"
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER=VIFA-951002
      - RABBITMQ_DEFAULT_PASS=VIFA-951002-PASS
  prometheus:
    image: prom/prometheus
    restart: always
    ports:
      - "9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
  grafana:
    image: grafana/grafana
    restart: always
    ports:
      - "3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=VIFA-951002-PASS
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana.yaml:/etc/grafana/provisioning/datasources
  msc-registry-server:
    image: vifa951002/msc-registry-server

    restart: always

    environment:
      - management.endpoints.web.exposure.include=*
      - LOKI_URL=http://loki:3100/loki/api/v1/push
  msc-api-gateway:
    image: vifa951002/msc-api-gateway

    restart: always
    depends_on:
      - msc-registry-server

    environment:
      - eureka.client.service-url.defaultZone=http://msc-registry-server:8761/eureka/
      - LOKI_URL=http://loki:3100/loki/api/v1/push

  msc-ms-file:
    image: vifa951002/msc-ms-file
    depends_on:
      - msc-registry-server
    restart: always
    deploy:
      resources:
        limits:
          cpus: 1.0
          memory: 250mb
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
    environment:
      - spring.datasource.url=jdbc:mysql://db:3307/msc_development
      - spring.datasource.username=root
      - spring.datasource.password=admin
      - spring.jpa.hibernate.ddl-auto=none
      - spring.jpa.generate-ddl=false
      - spring.jpa.show-sql=true
      - spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
      - msc.security.secret-key=NDQxQlROR1NuY2JjMTVOVFZBeURzZk5saXVNdmNKUWtiTGo3eEtoeVdVVkJLanBvWHludFFwWEM2amxCaXBscw==
      - msc.minio.access.key=VIFA-951002
      - msc.minio.access.secret=VIFA-951002-PASS
      - msc.minio.url=http://minio:9000
      - spring.rabbitmq.username=VIFA-951002
      - spring.rabbitmq.password=VIFA-951002-PASS
      - spring.rabbitmq.host=rabbitmq
      - spring.rabbitmq.port=5672
      - eureka.instance.metadata-map.metrics.path=/ms-file/actuator/prometheus
      - eureka.client.service-url.defaultZone=http://msc-registry-server:8761/eureka/
      - LOKI_URL=http://loki:3100/loki/api/v1/push

volumes:
  minio_data:
  grafana_data:
